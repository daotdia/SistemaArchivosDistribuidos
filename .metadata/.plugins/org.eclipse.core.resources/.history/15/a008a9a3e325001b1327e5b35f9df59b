package es.uned.sisdist.servidor;

import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import es.uned.sisdist.common.MetaFichero;
import es.uned.sisdist.common.Repositorio;
import es.uned.sisdist.common.ServicioDatosInterface;
import es.uned.sisdist.common.ServicioGestorInterface;
import es.uned.sisdist.common.ServicioSrOperadorInterface;
import es.uned.sisdist.common.URL;

public class ServicioGestorImpl implements ServicioGestorInterface{
	private ServicioDatosInterface servicio_datos;
	private ServicioSrOperadorInterface sso;
	
	public ServicioGestorImpl () {
		Registry registry =  LocateRegistry.getRegistry(7777);
		
		servicio_datos = (ServicioDatosInterface) registry.lookup("datos_remotos"); 
		sso = (ServicioSrOperadorInterface) registry.lookup("sso_remoto");
	}
	@Override
	public void subirFichero() throws RemoteException {
		
	}

	@Override
	public void bajarFichero(String nombre_cliente, String nombre_fichero, String path_local) throws RemoteException {
		Repositorio repo;
		boolean bandera = false;
		HashMap<String,List<MetaFichero>> ficheros_usuario = servicio_datos.getListaFicheros(nombre_cliente);
		for(Map.Entry<String,List<MetaFichero>> entrada : ficheros_usuario.entrySet()) {
			for(MetaFichero fichero : entrada.getValue()) {
				if(fichero.getNombre().equals(nombre_fichero)) {
					repo = servicio_datos.getRepositorioActivo(entrada.getKey());
					sso.bajarFichero(repo, nombre_fichero, path_local, nombre_cliente);
					bandera = true;
					break;
				}
			}
		}
		if (!bandera) {
			throw new RuntimeException ("Fichero de nombre " + nombre_fichero + " no encontrado");
		}
	}
	}

	@Override
	public URL borrarFichero(int sesion, int identificador) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<Integer> compartirFichero(int sesion, int identificador, List<Integer> destinatarios)
			throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<String> getListaFicheros(int sesion) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<String> getListaClientes(int sesion) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<Integer> getListaRepositorios(int sesion) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public Map<Integer, List<Integer>> getRepositoriosCliente(int sesion) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public void salir() throws RemoteException {
		// TODO Auto-generated method stub
		
	}

}

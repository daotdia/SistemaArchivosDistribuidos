package es.uned.sisdist.servidor;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import es.uned.sisdist.common.MetaFichero;
import es.uned.sisdist.common.Repositorio;
import es.uned.sisdist.common.ServicioDatosInterface;

public class ServicioDatosImpl implements ServicioDatosInterface{

	private List<String> usuarios_registrados;
	private List<Repositorio> repositorios_registrados;
	private HashMap<String, Integer> usuarios_activos;
	private HashMap<Repositorio, Integer> repositorios_activos;
	private HashMap<Integer,List<Repositorio>> repositorios_usuario;
	private HashMap<Integer, List<MetaFichero>> ficheros_usuario;
	
	public ServicioDatosImpl (List<Repositorio> repositorios) {
		usuarios_registrados = new ArrayList<String>();
		repositorios_registrados = new ArrayList<Repositorio>();
		usuarios_activos = new HashMap<String,Integer>();
		repositorios_activos = new HashMap<Repositorio,Integer>();
		repositorios_usuario = new HashMap<Integer,List<Repositorio>>();
		ficheros_usuario = new HashMap<Integer,List<MetaFichero>>();
	}

	public void registrarCliente(String nombre) throws RemoteException {
		usuarios_registrados.add(nombre);
	}

	public void registrarRepositorio(Repositorio repo) throws RemoteException {
		repositorios_registrados.add(repo);
	}

	public void deleteCliente(String nombre) throws RemoteException {
		usuarios_registrados.remove(usuarios_registrados.indexOf(nombre));
	}

	public void deleteRepositorio(String nombre) throws RemoteException {
		repositorios_registrados.remove(repositorios_registrados.indexOf(nombre));
	}

	//Para añadir repositorio o usuario al Map de activos.
	public void addId(String nombre, int identificador, int tipo) throws RemoteException {
		if(tipo == 0) {
			usuarios_activos.put(nombre, identificador);
		}
		else
			repositorios_activos.put(nombre, identificador);
	}

	@Override
	public int linkRepositorio(int id_cliente) throws RemoteException {
		int identificador = -1;
		if(!repositorios_activos.isEmpty()) {
			//Añado un repositorio aleatorio a la lista de repositorios del usuario.
			int ialea = (int) Math.random()*repositorios_activos.size();
			Repositorio [] keys = (Repositorio []) repositorios_activos.keySet().toArray();
			Repositorio repo = keys[ialea];
			repositorios_usuario.get(id_cliente).add(repo);
			//Asocio el identificador con el identificador del repositorio añadido.
			identificador = repositorios_activos.get(keys[ialea]);
		}
		else 
			throw new RuntimeException ("No quedan repositorios libres, vuelva a intentarlo más tarde o inicialice un nuevo repositorio");
		return identificador;
	}

	public int unlinkRepositorios(int id_cliente) throws RemoteException {
		int identificador = -1;
		ArrayList<Repositorio> repositorios = (ArrayList<Repositorio>) repositorios_usuario.get(id_cliente);
		
		if(!repositorios.isEmpty()) {
			identificador = repositorios.get(0).getId();
			repositorios.clear();
		}
		
		return identificador;
	}

	public List<Repositorio> getRepositoriosCliente(int id_cliente) throws RemoteException {
		return repositorios_usuario.get(id_cliente);
	}
	
	public List<Repositorio> getListaRepositoriosLinkados() throws RemoteException {
		List<Repositorio> repositorios_linkados = new ArrayList<Repositorio>();
		//Añado todos los repositorios linkados actualmente a usuarios.
		for (Map.Entry<Integer,List<Repositorio>> entrada : repositorios_usuario.entrySet()) {
			for(Repositorio repo : entrada.getValue()) {
				repositorios_linkados.add(repo);
			}
		}
		return repositorios_linkados;
	}
	
	public List<Repositorio> getListaRepositoriosRegistrados() throws RemoteException {
		return repositorios_registrados;
	}
	
	public  HashMap<Repositorio, Integer> getListaRepositoriosActivos() throws RemoteException {
		return repositorios_activos;
	} 

	//PENDIENTE DE VER COMO SON LOS ARCHIVOS DEL EQUIPO DOCENTE 
	public List<MetaFichero> getListaFicheros(int sesion) throws RemoteException {
		// TODO Auto-generated method stub
		return null;
	}

	public List<String> getListaClientesRegistrados() throws RemoteException {
		return usuarios_registrados;
	}

	public HashMap<String, Integer> getListaClientesActivos() throws RemoteException {
		return usuarios_activos;
	}
}
